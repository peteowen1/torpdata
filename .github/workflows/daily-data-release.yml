name: Daily Data Release

on:
  schedule:
    # Run at 2:00 AM AEST (16:00 UTC previous day)
    # This timing catches late Monday night games
    - cron: '0 16 * * *'
  workflow_dispatch:
    inputs:
      force_release:
        description: 'Force release (skip new games check)'
        type: boolean
        default: false
      rebuild_aggregates:
        description: 'Rebuild all historical aggregated files (2021-2025)'
        type: boolean
        default: false

env:
  GITHUB_PAT: ${{ secrets.WORKFLOW_PAT }}
  R_KEEP_PKG_SOURCE: yes

jobs:
  release-data:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout torpdata
        uses: actions/checkout@v4

      - name: Checkout torp
        uses: actions/checkout@v4
        with:
          repository: peteowen1/torp
          token: ${{ secrets.WORKFLOW_PAT }}
          path: torp

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.4.0'
          use-public-rspm: true

      - name: Setup R dependencies
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          working-directory: torp
          cache-version: 3
          extra-packages: |
            any::devtools
            any::piggyback
            any::fitzRoy
            any::tictoc
            any::mgcv
            any::cli
            any::glue
            any::data.table
            any::janitor
            any::lubridate
          needs: |
            devtools

      - name: Run daily release
        id: daily_release
        working-directory: torp
        run: |
          Rscript -e "
            devtools::load_all()
            source('data-raw/01-data/daily_release.R')
            force <- as.logical(Sys.getenv('FORCE_RELEASE', 'FALSE'))
            run_daily_release(force = force)
          "
          echo "release_success=true" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FORCE_RELEASE: ${{ inputs.force_release || 'FALSE' }}

      - name: Verify release uploads
        id: verify_release
        working-directory: torp
        run: |
          # Verify at least one expected parquet file exists on the release
          Rscript -e "
            devtools::load_all()
            season <- get_afl_season()
            expected_file <- paste0('pbp_data_', season, '_all.parquet')
            releases <- piggyback::pb_list(repo = 'peteowen1/torpdata', tag = 'pbp-data')
            if (!expected_file %in% releases[['file_name']]) {
              stop('Release verification failed: ', expected_file, ' not found on pbp-data release')
            }
            cat('Release verified:', expected_file, 'found\n')
          "
          echo "release_verified=true" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Rebuild historical aggregates
        if: inputs.rebuild_aggregates
        working-directory: torp
        run: Rscript data-raw/01-data/create_aggregated_files.R
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get release info
        id: release_info
        working-directory: torp
        run: |
          AFL_SEASON=$(Rscript -e "devtools::load_all(); cat(get_afl_season())")
          AFL_ROUND=$(Rscript -e "devtools::load_all(); cat(get_afl_week())")
          echo "afl_season=$AFL_SEASON" >> $GITHUB_OUTPUT
          echo "afl_round=$AFL_ROUND" >> $GITHUB_OUTPUT

      - name: Dispatch ratings trigger to torp
        if: steps.verify_release.outputs.release_verified == 'true'
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.WORKFLOW_PAT }}
          repository: peteowen1/torp
          event-type: ratings-trigger
          client-payload: '{"season": "${{ steps.release_info.outputs.afl_season }}", "round": "${{ steps.release_info.outputs.afl_round }}"}'

      - name: Create release summary
        run: |
          {
            echo "## Daily Data Release Summary"
            echo ""
            echo "**Date:** $(date +'%Y-%m-%d %H:%M UTC')"
            echo "**AFL Season:** $AFL_SEASON"
            echo "**AFL Round:** $AFL_ROUND"
            echo ""
            echo "### Data Updated"
            echo "- Chains data (per-round + aggregated)"
            echo "- Play-by-play data (per-round + aggregated)"
            echo "- Expected goals (xG) data"
            echo "- Player statistics"
            echo "- Fixtures"
            echo "- Results"
            echo "- Team lineups"
            echo "- Player details"
            echo ""
            echo "### Downstream"
            echo "- Dispatched ratings-trigger to peteowen1/torp"
            echo ""
            echo "### Force Flags"
            echo "- Force release: $FORCE_RELEASE"
            echo "- Rebuild aggregates: $REBUILD_AGGREGATES"
          } >> $GITHUB_STEP_SUMMARY
        env:
          AFL_SEASON: ${{ steps.release_info.outputs.afl_season }}
          AFL_ROUND: ${{ steps.release_info.outputs.afl_round }}
          FORCE_RELEASE: ${{ inputs.force_release || false }}
          REBUILD_AGGREGATES: ${{ inputs.rebuild_aggregates || false }}

      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'Daily Data Release Failed';
            const body = `The daily data release workflow failed on ${new Date().toISOString()}.

            **Details:**
            - Season: ${{ steps.release_info.outputs.afl_season || 'unknown' }}
            - Round: ${{ steps.release_info.outputs.afl_round || 'unknown' }}

            Please check the [workflow run](${context.payload.repository.html_url}/actions/runs/${context.runId}) for details.

            **Troubleshooting:**
            1. Check if fitzRoy API is accessible
            2. Verify WORKFLOW_PAT has write permissions to torpdata releases
            3. Review error logs for specific data type failures

            **Manual Recovery:**
            - Run workflow manually with "Force release" checked`;

            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'automation,bug'
            });

            const existingIssue = issues.data.find(i => i.title === title);

            if (existingIssue) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `Workflow failed again on ${new Date().toISOString()}.\n\n[View run](${context.payload.repository.html_url}/actions/runs/${context.runId})`
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['bug', 'automation']
              });
            }
